{% extends "base.html" %}
  {% load static %}

  {% block title %}{{ sala.nome }} - Sala Virtual{% endblock %}

  {% block extra_css %}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
      .tab-content { 
          padding: var(--space-lg); 
          border: 1px solid var(--color-gray-300); 
          border-top: none; 
          animation: fadeIn var(--transition-normal); 
      }
      .dark-mode .tab-content { 
          border-color: var(--color-gray-700); 
      }
      .nav-tabs .nav-link { 
          color: var(--color-dark); 
          transition: color var(--transition-normal); 
      }
      .nav-tabs .nav-link.active { 
          background-color: var(--color-primary); 
          color: var(--color-dark); 
      }
      .dark-mode .nav-tabs .nav-link { 
          color: var(--color-dark-mode-text); 
      }
      .dark-mode .nav-tabs .nav-link.active { 
          background-color: var(--color-primary-dark); 
          color: var(--color-white); 
      }
      .chat-box { 
          border: 1px solid var(--color-gray-300); 
          border-radius: var(--border-radius-md); 
          max-height: 400px; 
          overflow-y: auto; 
      }
      .dark-mode .chat-box { 
          border-color: var(--color-gray-700); 
      }
      .progress-bar { 
          background-color: var(--color-primary); 
      }
      .dark-mode .progress-bar { 
          background-color: var(--color-primary-dark); 
      }
      @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
      }
  </style>
  {% endblock %}

  {% block content %}
  <div class="container mt-5">
      <h2>{{ sala.nome }}</h2>
      <ul class="nav nav-tabs" id="salaTabs" role="tablist">
          <li class="nav-item">
              <a class="nav-link active" id="missoes-tab" data-bs-toggle="tab" href="#missoes" role="tab" aria-controls="missoes" aria-selected="true">
                  <i class="bi bi-list-task"></i> Missões
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" id="chat-tab" data-bs-toggle="tab" href="#chat" role="tab" aria-controls="chat" aria-selected="false">
                  <i class="bi bi-chat-dots"></i> Chat
              </a>
          </li>
          <li class="nav-item">
              <a class="nav-link" id="info-tab" data-bs-toggle="tab" href="#info" role="tab" aria-controls="info" aria-selected="false">
                  <i class="bi bi-info-circle"></i> Informações
              </a>
          </li>
          <li class="nav-item ms-auto">
              <button id="theme-toggle" class="btn btn-outline-secondary">Alternar Tema</button>
          </li>
      </ul>
      <div class="tab-content">
          <div class="tab-pane fade show active" id="missoes" role="tabpanel" aria-labelledby="missoes-tab">
              <h3>Missões</h3>
              {% if sala.tipo_usuario_criador == 'professor' and request.user == sala.criador %}
              <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#postarMissaoModal">
                  Postar Nova Missão
              </button>
              {% endif %}
              <div class="row">
                  {% for missao in missões %}
                  <div class="col-md-4 mb-3">
                      <div class="card">
                          <div class="card-body">
                              <h5>{{ missao.titulo }}</h5>
                              <p>{{ missao.descricao }}</p>
                              <p>Pontos: {{ missao.pontos }}</p>
                              {% if missao.progresso %}
                              <div class="progress mb-2">
                                  <div class="progress-bar" role="progressbar" style="width: {{ missao.progresso }}%;" aria-valuenow="{{ missao.progresso }}" aria-valuemin="0" aria-valuemax="100">{{ missao.progresso }}%</div>
                              </div>
                              {% endif %}
                              <a href="{% url 'usuarios:chat_missao' missao.id %}" class="btn btn-primary">Entrar no Chat</a>
                          </div>
                      </div>
                  </div>
                  {% endfor %}
              </div>
          </div>
          <div class="tab-pane fade" id="chat" role="tabpanel" aria-labelledby="chat-tab">
              <h3>Chat Principal</h3>
              <div class="chat-box">
                  {% for mensagem in mensagens %}
                  <p><strong>{{ mensagem.usuario.email }}:</strong> {{ mensagem.texto }} <small class="text-muted">({{ mensagem.data_envio }})</small></p>
                  {% endfor %}
              </div>
              <form method="post" id="chatForm">
                  {% csrf_token %}
                  {{ form.as_p }}
                  <button type="submit" class="btn btn-primary mt-2">Enviar</button>
              </form>
          </div>
          <div class="tab-pane fade" id="info" role="tabpanel" aria-labelledby="info-tab">
              <h3>Informações da Sala</h3>
              <p><strong>Nome:</strong> {{ sala.nome }}</p>
              <p><strong>Descrição:</strong> {{ sala.descricao }}</p>
              <p><strong>Criador:</strong> {{ sala.criador.email }}</p>
              <p><strong>Tipo:</strong> {{ sala.tipo_usuario_criador }}</p>
          </div>
      </div>

      <!-- Modal para Postar Missão -->
      <div class="modal fade" id="postarMissaoModal" tabindex="-1" aria-labelledby="postarMissaoModalLabel" aria-hidden="true">
          <div class="modal-dialog">
              <div class="modal-content">
                  <div class="modal-header">
                      <h5 class="modal-title" id="postarMissaoModalLabel">Postar Nova Missão</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                      <form method="post" action="{% url 'usuarios:postar_missao' sala.id %}" id="missaoForm">
                          {% csrf_token %}
                          {{ form_missao.as_p }}
                          <button type="submit" class="btn btn-primary">Postar Missão</button>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>
  {% endblock %}

  {% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
      const toggleButton = document.getElementById('theme-toggle');
      toggleButton.addEventListener('click', () => {
          document.body.classList.toggle('dark-mode');
          localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
      });
      if (localStorage.getItem('theme') === 'dark') {
          document.body.classList.add('dark-mode');
      }
  </script>
  {% endblock %}