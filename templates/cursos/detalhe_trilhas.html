{% extends "base.html" %}
{% load static %}

{% block title %}{{ trilha.nome }} - Player{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- Cabeçalho -->
    <div class="mb-4">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div class="flex-grow-1">
                <h1 class="h3 text-warning mb-2">
                    <i class="bi bi-map"></i> {{ trilha.nome }}
                </h1>
                <p class="text-muted mb-2">{{ trilha.descricao }}</p>
                <div class="d-flex flex-wrap gap-2 align-items-center">
                    <span class="badge bg-info">
                        <i class="bi bi-door-open"></i> {{ trilha.sala.nome }}
                    </span>
                    {% if trilha.pontos_necessarios > 0 %}
                        <span class="badge bg-warning text-dark">
                            {{ trilha.pontos_necessarios }} pontos necessários
                        </span>
                    {% endif %}
                </div>
            </div>
            
            <div class="d-flex gap-2">
                {% if is_professor %}
                    <button class="btn btn-warning text-dark btn-sm" data-bs-toggle="modal" data-bs-target="#criarModuloModal">
                        <i class="bi bi-plus-circle"></i> Adicionar Módulo
                    </button>
                {% endif %}
                <a href="{% url 'cursos:lista_trilhas' %}" class="btn btn-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <!-- Progresso Geral -->
    <div class="card card-no-scale mb-4 border-warning">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Seu Progresso Geral</h6>
                <span class="badge bg-warning text-dark fs-6">{{ progresso_geral }}%</span>
            </div>
            <div class="progress" style="height: 20px; border-radius: 10px;">
                <div class="progress-bar bg-gradient" 
                     style="width: {{ progresso_geral }}%; background: linear-gradient(90deg, #FFC107 0%, #FFA000 100%);"
                     role="progressbar">
                    <span class="fw-bold">{{ progresso_geral }}%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Módulos -->
    {% if modulos_com_progresso %}
        {% for item in modulos_com_progresso %}
        <div class="card card-no-scale mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> {{ item.modulo.titulo }}
                </h5>
                <span class="badge bg-dark">{{ item.completos }}/{{ item.total }}</span>
            </div>
            
            <div class="card-body">
                <!-- Descrição do Módulo -->
                {% if item.modulo.descricao %}
                    <p class="text-muted mb-3">{{ item.modulo.descricao }}</p>
                {% endif %}
                
                <!-- Progresso do Módulo -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Progresso do Módulo</small>
                        <small class="text-warning fw-bold">{{ item.progresso }}%</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" 
                             style="width: {{ item.progresso }}%;"
                             role="progressbar"></div>
                    </div>
                </div>

                <!-- Lista de Conteúdos -->
                <div class="list-group list-group-flush">
                    {% for conteudo_info in item.conteudos %}
                        <a href="{% url 'cursos:visualizar_conteudo' conteudo_info.conteudo.id %}" 
                           class="list-group-item list-group-item-action d-flex justify-content-between align-items-center
                                  {% if conteudo_info.completo %}list-group-item-success{% endif %}">
                            <div class="d-flex align-items-center gap-3 flex-grow-1">
                                <!-- Ícone de Status -->
                                <div class="status-icon">
                                    {% if conteudo_info.completo %}
                                        <i class="bi bi-check-circle-fill text-success fs-4"></i>
                                    {% elif conteudo_info.visualizado %}
                                        <i class="bi bi-eye-fill text-primary fs-4"></i>
                                    {% else %}
                                        <i class="bi bi-circle text-muted fs-4"></i>
                                    {% endif %}
                                </div>
                                
                                <!-- Informações do Conteúdo -->
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center gap-2 flex-wrap">
                                        <strong>{{ conteudo_info.conteudo.titulo }}</strong>
                                        
                                        <!-- Tipo de Conteúdo -->
                                        {% if conteudo_info.conteudo.tipo == 'video' %}
                                            <span class="badge bg-danger"><i class="bi bi-play-fill"></i> Vídeo</span>
                                        {% elif conteudo_info.conteudo.tipo == 'arquivo' %}
                                            <span class="badge bg-info"><i class="bi bi-file-earmark"></i> Arquivo</span>
                                        {% elif conteudo_info.conteudo.tipo == 'link' %}
                                            <span class="badge bg-primary"><i class="bi bi-link-45deg"></i> Link</span>
                                        {% else %}
                                            <span class="badge bg-secondary"><i class="bi bi-file-text"></i> Texto</span>
                                        {% endif %}
                                        
                                        <!-- Duração -->
                                        {% if conteudo_info.conteudo.duracao_estimada > 0 %}
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i> {{ conteudo_info.conteudo.duracao_estimada }} min
                                            </small>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Data de visualização -->
                                    {% if conteudo_info.data_visualizacao %}
                                        <small class="text-muted">
                                            Visto em {{ conteudo_info.data_visualizacao|date:"d/m/Y H:i" }}
                                        </small>
                                    {% endif %}
                                </div>
                                
                                <!-- Seta de navegação -->
                                <i class="bi bi-chevron-right text-muted"></i>
                            </div>
                        </a>
                    {% endfor %}
                </div>

                <!-- Missões Relacionadas -->
                {% if item.missoes %}
                    <div class="mt-4">
                        <h6 class="text-warning mb-3">
                            <i class="bi bi-lightning-fill"></i> Missões Relacionadas
                        </h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for missao in item.missoes %}
                                <a href="{% url 'usuarios:chat_missao' missao.id %}" 
                                   class="btn btn-sm btn-outline-warning">
                                    {{ missao.titulo }} ({{ missao.pontos }} pts)
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Botão Adicionar Conteúdo (Professor) -->
                {% if is_professor %}
                    <div class="mt-4 d-grid">
                        <button class="btn btn-sm btn-outline-warning" 
                                data-bs-toggle="modal" 
                                data-bs-target="#adicionarConteudoModal{{ item.modulo.id }}">
                            <i class="bi bi-plus-circle"></i> Adicionar Conteúdo a Este Módulo
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Modal Adicionar Conteúdo -->
        {% if is_professor %}
        <div class="modal fade" id="adicionarConteudoModal{{ item.modulo.id }}" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-white border-warning">
                    <div class="modal-header bg-warning text-dark border-warning">
                        <h5 class="modal-title">
                            <i class="bi bi-plus-circle"></i> Adicionar Conteúdo
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="post" action="{% url 'cursos:adicionar_conteudo' item.modulo.id %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label text-white fw-bold">Título do Conteúdo</label>
                                <input type="text" name="titulo" class="form-control input-estilo bg-dark text-white" 
                                       placeholder="Ex: Introdução ao tema" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white fw-bold">Tipo de Conteúdo</label>
                                <select name="tipo" class="form-control input-estilo bg-dark text-white" required>
                                    <option value="texto">Texto/Artigo</option>
                                    <option value="video">Vídeo</option>
                                    <option value="arquivo">Arquivo/PDF</option>
                                    <option value="link">Link Externo</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white fw-bold">Conteúdo Textual (opcional)</label>
                                <textarea name="conteudo" class="form-control input-estilo bg-dark text-white" 
                                          rows="5" placeholder="Cole ou escreva o conteúdo aqui..."></textarea>
                                <small class="text-white-50">Use para tipo "Texto/Artigo"</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white fw-bold">Link (opcional)</label>
                                <input type="url" name="link" class="form-control input-estilo bg-dark text-white" 
                                       placeholder="https://exemplo.com">
                                <small class="text-white-50">Use para vídeos do YouTube ou links externos</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white fw-bold">Arquivo (opcional)</label>
                                <input type="file" name="arquivo" class="form-control input-estilo bg-dark text-white"
                                       accept=".pdf,.doc,.docx,.ppt,.pptx,.mp4,.mp3">
                                <small class="text-white-50">PDF, DOC, vídeos, etc.</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label text-white fw-bold">Duração Estimada (minutos)</label>
                                <input type="number" name="duracao_estimada" class="form-control input-estilo bg-dark text-white" 
                                       value="0" min="0">
                            </div>
                        </div>
                        <div class="modal-footer border-warning">
                            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-warning text-dark fw-bold btn-sm">
                                <i class="bi bi-check-circle"></i> Adicionar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    {% else %}
        <!-- Estado Vazio -->
        <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1 opacity-50"></i>
            <h5 class="mt-3">Nenhum módulo criado ainda</h5>
            {% if is_professor %}
                <p>Comece criando o primeiro módulo desta trilha.</p>
                <button class="btn btn-warning text-dark mt-3" data-bs-toggle="modal" data-bs-target="#criarModuloModal">
                    <i class="bi bi-plus-circle"></i> Criar Primeiro Módulo
                </button>
            {% else %}
                <p>O professor ainda não adicionou conteúdos.</p>
            {% endif %}
        </div>
    {% endif %}
</div>

<!-- Modal Criar Módulo -->
{% if is_professor %}
<div class="modal fade" id="criarModuloModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-warning">
            <div class="modal-header bg-warning text-dark border-warning">
                <h5 class="modal-title">
                    <i class="bi bi-book"></i> Criar Novo Módulo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'cursos:criar_modulo' trilha.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label text-white fw-bold">Título do Módulo</label>
                        <input type="text" name="titulo" class="form-control input-estilo bg-dark text-white" 
                               placeholder="Ex: Módulo 1: Introdução" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-white fw-bold">Descrição (opcional)</label>
                        <textarea name="descricao" class="form-control input-estilo bg-dark text-white" 
                                  rows="3" placeholder="Descreva o que será abordado..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-warning">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-warning text-dark fw-bold btn-sm">
                        <i class="bi bi-check-circle"></i> Criar Módulo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}

<style>
.list-group-item {
    transition: all 0.2s ease;
}

.list-group-item:hover {
    background-color: rgba(255, 193, 7, 0.1);
    transform: translateX(5px);
}

.list-group-item-success {
    background-color: rgba(40, 167, 69, 0.1);
    border-left: 4px solid #28a745;
}

.status-icon {
    min-width: 40px;
    text-align: center;
}

@media (max-width: 576px) {
    .list-group-item {
        padding: 0.75rem 0.5rem;
    }
    
    .status-icon i {
        font-size: 1.25rem !important;
    }
}
</style>
{% endblock %}