{% extends "base.html" %}
{% load static %}

{% block title %}Chat da Missão - {{ missao.titulo }}{% endblock %}

{% block content %}
<div class="container chat-page-container">
    <div class="chat-wrapper">

        <!-- Header da Missão -->
        <div class="chat-header">
            <h2><i class="fas fa-tasks me-2"></i>{{ missao.titulo }}</h2>
            <p>{{ missao.descricao }}</p>
            <div class="badges">
                <span class="badge bg-light text-dark">
                    {% if missao.status == 'pendente' %}Pendente{% elif missao.status == 'concluida' %}Concluída{% else %}Corrigida{% endif %}
                </span>
                <span class="badge bg-warning text-dark"><i class="fas fa-star"></i> {{ missao.pontos }} pontos</span>
                {% if missao.status == 'corrigida' %}
                <span class="badge bg-success"><i class="fas fa-trophy"></i> {{ missao.pontos_atingidos }} obtidos</span>
                {% endif %}
            </div>
        </div>

        <!-- Mensagens -->
        <div class="chat-messages" id="messagesContainer">
            {% if mensagens %}
                {% for msg in mensagens %}
                <div class="message {% if msg.usuario == user %}me{% else %}other{% endif %}">
                    <div class="bubble">
                        <div class="bubble-header">
                            <strong>
                                {% firstof msg.usuario.get_full_name msg.usuario.email|truncatechars:20 "Usuário" %}
                            </strong>
                            <small class="ms-2 text-muted">{{ msg.data_envio|date:"d/m H:i" }}</small>
                        </div>
                        <div>{{ msg.texto|linebreaks }}</div>
                        {% if msg.arquivo %}
                        <div class="file-box">
                            <i class="fas fa-paperclip"></i>
                            <a href="{{ msg.arquivo.url }}" target="_blank">
                                {{ msg.arquivo.name|slice:":35" }}{% if msg.arquivo.name|length > 35 %}...{% endif %}
                            </a>
                            <small>({{ msg.arquivo.size|filesizeformat }})</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="text-center">
                        <i class="fas fa-comments fa-4x mb-3 opacity-50"></i>
                        <p>Nenhuma mensagem ainda.<br>Inicie a conversa!</p>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Input de envio (aparece apenas se a missão não estiver corrigida) -->
        {% if missao.status != 'corrigida' %}
        <div class="chat-input">
            <form method="post" enctype="multipart/form-data" class="input-area">
                {% csrf_token %}
                <textarea name="texto" class="form-control input-estilo" placeholder="Escreva sua resposta..." rows="1" required></textarea>
                <label class="btn btn-attach">
                    <i class="fas fa-paperclip"></i>
                    <input type="file" name="arquivo" style="display:none;">
                </label>
                <button type="submit" class="btn btn-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            {% if missao.status == 'pendente' and not is_professor %}
            <small class="text-muted text-center d-block mt-2">
                Sua primeira mensagem marcará a missão como concluída
            </small>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <!-- Área de correção do professor -->
    {% if is_professor and missao.status == 'concluida' %}
    <div class="card correction-box text-center">
        <div class="card-body py-4">
            <h4 class="text-warning mb-3"><i class="fas fa-graduation-cap"></i> Correção da Missão</h4>
            <form method="post" class="d-inline-block">
                {% csrf_token %}
                <input type="hidden" name="corrigir_missao" value="true">
                <div class="d-flex justify-content-center align-items-end gap-3 flex-wrap">
                    <div>
                        <label class="form-label text-white fw-bold">Pontos obtidos</label>
                        <input type="number" name="pontos_atingidos" min="0" max="{{ missao.pontos }}"
                               class="form-control input-estilo text-center" style="width:130px;font-size:1.8rem;" required>
                        <small class="text-muted">máx. {{ missao.pontos }}</small>
                    </div>
                    <button type="submit" class="btn btn-success btn-lg px-5">
                        <i class="fas fa-check-circle"></i> Corrigir
                    </button>
                </div>
                <div class="text-danger mt-3"><i class="fas fa-exclamation-triangle"></i> Ação irreversível</div>
            </form>
        </div>
    </div>
    {% endif %}

    <!-- Missão já corrigida -->
    {% if missao.status == 'corrigida' %}
    <div class="alert alert-info text-center mt-4">
        <i class="fas fa-lock fa-2x"></i><br>
        <strong>Missão corrigida!</strong> Chat bloqueado para novas mensagens.
    </div>
    {% endif %}

    <div class="text-center mt-4">
        <a href="{% url 'usuarios:sala_virtual' missao.sala.id %}" class="btn btn-outline-secondary btn-lg">
            <i class="fas fa-arrow-left"></i> Voltar à Sala
        </a>
    </div>
</div>

<script>
    // Scroll automático para o final
    const container = document.getElementById('messagesContainer');
    container.scrollTop = container.scrollHeight;

    // Auto-resize do textarea
    const textarea = document.querySelector('textarea[name="texto"]');
    if (textarea) {
        textarea.addEventListener('input', function () {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
    }
</script>
{% endblock %}