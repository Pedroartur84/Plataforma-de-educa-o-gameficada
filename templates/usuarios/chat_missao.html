{% extends "base.html" %}
{% load static %}

{% block title %}Missão - {{ missao.titulo }}{% endblock %}

{% block content %}
<main class="container-fluid py-3">
  <header class="d-flex flex-column flex-md-row justify-content-between align-items-start mb-3">
    <div>
      <h3 class="h5 text-warning fw-bold mb-1">{{ missao.titulo }}</h3>
      <div class="d-flex flex-wrap gap-2 align-items-center small">
        <span class="badge bg-warning text-dark">{{ missao.pontos }} pts</span>
        <span class="badge {% if missao.status == 'corrigida' %}bg-warning text-dark{% elif missao.status == 'concluida' %}bg-primary{% else %}bg-secondary{% endif %}">{{ missao.get_status_display }}</span>
        <span class="text-muted">{{ missao.sala.nome }}</span>
      </div>
    </div>
    <div class="mt-2 mt-md-0">
      <a href="{% url 'usuarios:sala_virtual' missao.sala.id %}" class="btn btn-sm btn-primary" aria-label="Voltar à sala"><i class="fas fa-arrow-left"></i> <span class="d-none d-md-inline">Voltar</span></a>
    </div>
  </header>

  <div>
    <ul class="nav nav-tabs nav-fill mb-3" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="chat-tab" data-bs-toggle="tab" data-bs-target="#chat-pane" type="button" role="tab"><i class="bi bi-chat-dots"></i> <span class="d-none d-md-inline">Chat</span></button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="info-tab" data-bs-toggle="tab" data-bs-target="#info-pane" type="button" role="tab"><i class="bi bi-info-circle"></i> <span class="d-none d-md-inline">Informações</span></button>
      </li>
      {% if is_professor_na_sala and entregas_com_dados %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="correcoes-tab" data-bs-toggle="tab" data-bs-target="#correcoes-pane" type="button" role="tab"><i class="bi bi-pencil-square"></i> <span class="d-none d-md-inline">Corrigir</span></button>
      </li>
      {% endif %}
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="chat-pane" role="tabpanel">
        <div class="card">
          <div class="card-header bg-warning text-dark"><h6 class="mb-0"><i class="bi bi-chat-dots"></i> Chat da Missão</h6></div>
          <div class="card-body bg-dark text-white p-2 d-flex flex-column chat-max">
            <div id="missao-chat-messages" class="flex-grow-1 overflow-auto mb-3 p-2 rounded chat-messages"></div>

            {% if missao.status != 'corrigida' %}
              <form method="post" enctype="multipart/form-data" class="d-flex gap-2 flex-column flex-md-row">
                {% csrf_token %}
                <textarea class="form-control bg-dark text-white flex-grow-1" name="texto" rows="2" placeholder="Escreva sua resposta..." required></textarea>
                <div class="d-flex gap-2 flex-column">
                  <input type="file" class="form-control form-control-sm bg-dark text-white" name="arquivo" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.zip">
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary btn-sm"> <i class="bi bi-chat-left"></i> Comentar</button>
                    <button type="submit" name="entregar" class="btn btn-success btn-sm"> <i class="bi bi-check-circle"></i> Entregar</button>
                  </div>
                </div>
              </form>
            {% else %}
              <div class="text-center text-muted py-3"><small><i class="bi bi-lock"></i> Missão corrigida - Chat encerrado</small></div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="info-pane" role="tabpanel">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark"><h6 class="mb-0"><i class="bi bi-file-text"></i> Descrição</h6></div>
              <div class="card-body">
                <p class="small">{{ missao.descricao|linebreaks }}</p>
                {% if missao.data_limite %}
                  <div class="alert alert-warning mt-2 small"> <i class="bi bi-calendar-event"></i> <strong>Data limite:</strong> {{ missao.data_limite|date:"d/m/Y H:i" }}</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-12 col-lg-6">
            <div class="card h-100">
              <div class="card-header bg-dark text-white"><h6 class="mb-0"><i class="bi bi-person-check"></i> Seu Status</h6></div>
              <div class="card-body">
                {% if not is_professor_na_sala %}
                  {% if ja_entregou %}
                    <div class="alert alert-success small mb-0"> <i class="bi bi-check-circle"></i> <strong>Entregue!</strong> <div class="small text-muted">Aguardando correção.</div></div>
                  {% else %}
                    <div class="alert alert-warning small mb-0"> <i class="bi bi-exclamation-circle"></i> <strong>Pendente</strong> <div class="small text-muted">Você ainda não entregou esta missão.</div></div>
                  {% endif %}
                {% else %}
                  <div class="alert alert-info small mb-0"> <i class="bi bi-mortarboard"></i> <strong>Modo Professor</strong> <div class="small text-muted">Corrija entregas na aba "Corrigir".</div></div>
                {% endif %}

                {% if is_professor_na_sala %}
                  <div class="mt-3 small">
                    <div class="mb-2 text-muted"><strong>Criada em:</strong> {{ missao.data_criacao|date:"d/m/Y H:i" }}</div>
                    <button type="button" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#anexoModal"><i class="bi bi-paperclip"></i> Anexar Arquivo</button>
                    {% if missao.anexos.all %}
                      <div class="mt-2 d-flex flex-wrap gap-2">
                        {% for anexo in missao.anexos.all %}
                          <a href="{{ anexo.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank"> <i class="bi bi-download"></i> {{ anexo.nome|default:anexo.arquivo.name }}</a>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if is_professor_na_sala and entregas_com_dados %}
      <div class="tab-pane fade" id="correcoes-pane" role="tabpanel">
        <div class="row g-3">
          {% for item in entregas_com_dados %}{% with aluno=item.aluno entrega=item.entrega %}
            <div class="col-12 col-md-6">
              <div class="card border-warning">
                <div class="card-body small">
                  <h6 class="mb-2">{{ aluno.get_nome_exibicao }}</h6>
                  {% if entrega.texto %}<p class="text-muted small mb-2"><i class="bi bi-chat-left-text"></i> {{ entrega.texto|truncatewords:20 }}</p>{% endif %}
                  <div class="d-grid gap-2">
                    {% if entrega.arquivo %}<a href="{{ entrega.arquivo.url }}" class="btn btn-sm btn-outline-primary" target="_blank"><i class="bi bi-download"></i> Ver Arquivo</a>{% endif %}
                    <button type="button" class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#correcaoModal{{ aluno.id }}"> <i class="bi bi-pencil"></i> Corrigir</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal de Correção -->
            <div class="modal fade" id="correcaoModal{{ aluno.id }}" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header bg-warning text-dark"><h5 class="modal-title">Corrigir - {{ aluno.get_nome_exibicao }}</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                  <form method="post">{% csrf_token %}<input type="hidden" name="aluno_id" value="{{ aluno.id }}">
                    <div class="modal-body small">
                      {% if entrega.texto %}<div class="mb-3"><strong>Resposta escrita:</strong><div class="p-3 bg-light rounded mt-2 small">{{ entrega.texto|linebreaks }}</div></div>{% endif %}
                      {% if entrega.arquivo %}<p><strong>Arquivo anexado:</strong><br><a href="{{ entrega.arquivo.url }}" target="_blank" class="btn btn-sm btn-outline-primary mt-2"><i class="bi bi-download"></i> Baixar</a></p>{% endif %}
                      <div class="mt-3"><label class="form-label fw-bold">Pontuação (0 a {{ missao.pontos }}):</label><div class="input-group"><input type="number" name="pontos_atingidos" class="form-control text-center" min="0" max="{{ missao.pontos }}" value="0" required><span class="input-group-text">/ {{ missao.pontos }}</span></div></div>
                    </div>
                    <div class="modal-footer"><button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button><button type="submit" name="corrigir" class="btn btn-success btn-sm">Salvar</button></div>
                  </form>
                </div>
              </div>
            </div>
          {% endwith %}{% endfor %}
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</main>

<style>
  .chat-container::-webkit-scrollbar{width:6px}
  .chat-container::-webkit-scrollbar-thumb{background:#6c757d;border-radius:3px}
  .nav-tabs .nav-link.active{border-bottom:3px solid #FFC107;color:#FFC107}
<style>
  .chat-messages::-webkit-scrollbar{width:6px}
  .chat-messages::-webkit-scrollbar-thumb{background:#6c757d;border-radius:3px}
  .nav-tabs .nav-link.active{border-bottom:3px solid #FFC107;color:#FFC107}
</style>

<script>document.addEventListener('DOMContentLoaded',function(){const el=document.querySelector('#missao-chat-messages'); if(el){setTimeout(()=>el.scrollTop=el.scrollHeight,100);}})</script>

<script>const MISSAO_CHAT_MESSAGES_URL = "{% url 'usuarios:missao_messages' missao.id %}"; const CURRENT_USER_ID = {{ request.user.id }};</script>
<script src="{% static 'js/chat_missao.js' %}"></script>
{% endblock %}